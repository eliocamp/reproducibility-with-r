---
title: "04: here are the portable paths"
weight: 4
show_post_date: false
publishDate: 2022-02-19
excerpt: ""
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<p>If you use RStudio Projects consistently, you can be sure that your working directory is always the root of the project unless you actively change it.
Almost.
There are two situations in which this assumption can be broken and that can lead to errors or, even worse, surprising results.</p>
<div id="root-directory-during-knit" class="section level2">
<h2>Root directory during knit</h2>
<p>One issue is that when RMarkdown files are knitted, the working directory in which the code is executed is the location of the .Rmd file, which is not always the root of the project.</p>
<p>To witness this, we prepared a demo project.</p>
<pre class="r"><code>penguins &lt;- read.csv(&quot;data/penguins.csv&quot;)</code></pre>
<div class="activity">
<p>Get the demo project</p>
<ol style="list-style-type: decimal">
<li>Download the <a href="/reproducibility-with-r/demo_project.zip">demo project</a> and extract it anywhere in your computer.</li>
<li>Open the project (double click on <code>demo_project.Rproj</code>), open <code>report-not_here.Rmd</code> and try to knit it.</li>
</ol>
</div>
<p>You’ll notice that R fails to render the file with an error that reads <code>Line 9 Error in file(file, "rt") : cannot open the connection</code>, indicating that there was an issue reading the file in line 9.</p>
<p>However, line 9 seems perfectly sensible:</p>
<pre class="r"><code>penguins &lt;- read.csv(&quot;data/penguins.csv&quot;)</code></pre>
<p>You can test that the working directory is the project root by running <code>getwd()</code> in the console:</p>
<pre class="r"><code>getwd()</code></pre>
<pre><code>## [1] &quot;/home/elio/Documents/cursos/reproducibility-with-r/static/demo_project&quot;</code></pre>
<p>And also that <code>penguins.csv</code> is indeed located un the <code>data</code> folder by running</p>
<pre class="r"><code>file.exists(&quot;data/penguins.csv&quot;)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>You can even try to read the data in the console</p>
<pre class="r"><code>head(read.csv(&quot;data/penguins.csv&quot;))</code></pre>
<pre><code>##   species    island bill_length_mm bill_depth_mm flipper_length_mm body_mass_g
## 1  Adelie Torgersen           39.1          18.7               181        3750
## 2  Adelie Torgersen           39.5          17.4               186        3800
## 3  Adelie Torgersen           40.3          18.0               195        3250
## 4  Adelie Torgersen             NA            NA                NA          NA
## 5  Adelie Torgersen           36.7          19.3               193        3450
## 6  Adelie Torgersen           39.3          20.6               190        3650
##      sex year
## 1   male 2007
## 2 female 2007
## 3 female 2007
## 4   &lt;NA&gt; 2007
## 5 female 2007
## 6   male 2007</code></pre>
<p>However, if you try to run the first chunk by setting the cursor over line 9 and pressing Ctrl + Enter, you’ll get the same error:</p>
<pre class="r"><code>penguins &lt;- read.csv(&quot;data/penguins.csv&quot;)</code></pre>
<pre><code>## Error in file(file, &quot;rt&quot;): cannot open the connection</code></pre>
<p>This is because when knitting, the working directory is set to the directory where the .Rmd file is located.
For consistency, RStudio runs code inside chunks with the same setup.
This inconsistency between the working directory of your session and that of the knitting process can be a source of a lot of headaches.</p>
<p>A possible solution would be to use absolute paths, so the current working directory is irrelevant.
But we saw that using absolute paths leads to code that runs only in one machine.</p>
<p>What the <strong>here</strong> package does is create absolute paths that work on the machine running the code from paths relative to the root directory.
The way you use the package is to always use paths relative to the root project directory but wrap them in the <code>here::here()</code> function.</p>
<div class="activity">
<p>Fix one error</p>
<ol style="list-style-type: decimal">
<li>Change line 9 in <code>report.Rmd</code> to</li>
</ol>
<pre><code>``` r
penguins &lt;- read.csv(here::here(&quot;data/penguins.csv&quot;))
```</code></pre>
<ol style="list-style-type: decimal">
<li>Try to knitr again.</li>
</ol>
</div>
</div>
<div id="defensive-programming-with-here" class="section level2">
<h2>Defensive programming with here</h2>
<p>The here package works every time as long as the current working directory is a subdirectory of the project root.
But it can be brittle otherwise.</p>
<div class="activity">
<p>Find a new error</p>
<ol style="list-style-type: decimal">
<li><p>Close demo_project.</p></li>
<li><p>Open <code>report.Rmd</code> in a new RStudio window. Make sure that you are <strong>not</strong> on the demo_project project.</p></li>
<li><p>Try to run line 9.</p></li>
<li><p>Create a new chunk with the code <code>here::here("data/penguins.csv")</code> and run it. Which absolute paths does it return?</p></li>
</ol>
</div>
<p>You’ll notice that if you break the expectation that you are working inside the correct project, <code>here()</code> will return essentially nonsense.
A more robust approach is to define the working directory by asserting the relative paths that leads to the current file.</p>
<div class="activity">
<p>Fix the new error</p>
<ol style="list-style-type: decimal">
<li><p>Add a new chunk at the beginning of the file that reads <code>here::i_am("analysis/report.Rmd")</code>.</p></li>
<li><p>Run this new chunk and the one after.</p></li>
</ol>
</div>
<p>With <code>here::i_am("analysis/report.Rmd")</code>, you are declaring the location of the current script relative to the project root.
This will set the project root that is consistent with this location and emit a message.
Importantly, it will fail if the declared location is not found in the working directory or any of the parent directories.</p>
</div>
